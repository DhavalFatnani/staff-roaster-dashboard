/**
 * workflows.cursor
 * 
 * Purpose: User stories and test scenarios in Gherkin format
 * 
 * Run notes:
 * - These are BDD (Behavior-Driven Development) scenarios
 * - Can be used with Cucumber, Jest-Cucumber, or similar tools
 * - Scenarios cover critical user flows and edge cases
 * - Use these as acceptance criteria for development
 */

// ============================================================================
// User Story 1: SM Creates Role and Bulk Imports Users
// ============================================================================

Feature: Role Creation and Bulk User Import
  As a Store Manager
  I want to create custom roles and bulk import users
  So that I can efficiently manage staff with specific permissions

  Background:
    Given I am logged in as a Store Manager
    And I have permission to create roles and users

  Scenario: SM creates a new role "Temp PP"
    Given I am on the Role Management page
    When I click "Create Role"
    And I enter role name "Temp PP"
    And I set description "Temporary picker packer role"
    And I select permissions "VIEW_ROSTER", "ASSIGN_TASK"
    And I set default experience level to "fresher"
    And I set default PP type to "adHoc"
    And I click "Create"
    Then I should see "Temp PP" role in the roles list
    And the role should have the specified permissions
    And the role should be editable

  Scenario: SM bulk imports 5 ad-hoc PP accounts via CSV
    Given I am on the User Management page
    And I have created the "Temp PP" role
    When I click "Bulk Import"
    And I paste CSV data with 5 users:
      | employeeId    | firstName | lastName | email                    | roleId      | experienceLevel | ppType |
      | PP-ADHOC-001  | Sam       | Temp     | sam.temp@example.com     | role-temp-pp| fresher         | adHoc  |
      | PP-ADHOC-002  | Pat       | Seasonal | pat.seasonal@example.com| role-temp-pp| fresher         | adHoc  |
      | PP-ADHOC-003  | Riley     | Contract | riley.contract@example  | role-temp-pp| fresher         | adHoc  |
      | PP-ADHOC-004  | Morgan    | PartTime | morgan.parttime@example  | role-temp-pp| fresher         | adHoc  |
      | PP-ADHOC-005  | Quinn     | Flex     | quinn.flex@example.com   | role-temp-pp| fresher         | adHoc  |
    And I click "Import"
    Then I should see 5 new users in the staff directory
    And all users should have role "Temp PP"
    And all users should be assignable to rosters

  Scenario: SM assigns imported users to a roster
    Given I have imported 5 ad-hoc PP users
    And I am on the Roster Builder page
    When I select date "2024-01-25" and shift "morning"
    And I assign 3 of the imported PP users to the roster
    And I click "Publish Roster"
    Then the roster should be published successfully
    And the 3 assigned users should appear in the published roster

// ============================================================================
// User Story 2: SI Creates Staff and Manages Week-Offs
// ============================================================================

Feature: SI Staff Management
  As a Shift In Charge
  I want to create staff accounts and manage their week-offs
  So that I can plan rosters effectively

  Background:
    Given I am logged in as a Shift In Charge
    And I have permission to create and edit staff

  Scenario: SI creates a new staff account
    Given I am on the User Management page
    When I click "Add User"
    And I enter employee ID "PP006"
    And I enter name "Alex Worker"
    And I enter email "alex.worker@example.com"
    And I select role "Picker Packer (Warehouse)"
    And I set experience level to "experienced"
    And I set week-offs to "Sunday, Monday"
    And I click "Create"
    Then I should see "Alex Worker" in the staff directory
    And the user should have the specified week-offs
    And the user should be assignable to rosters

  Scenario: SI edits staff experience level
    Given I have created a staff member "Alex Worker"
    When I click "Edit" on "Alex Worker"
    And I change experience level from "experienced" to "fresher"
    And I click "Update"
    Then the staff member should show experience level "fresher"
    And the change should be logged in audit log

  Scenario: SI assigns staff to a shift
    Given I have created a staff member "Alex Worker"
    And I am on the Roster Builder page
    When I select date "2024-01-26" and shift "morning"
    And I assign "Alex Worker" to an empty slot
    And I assign tasks "Order Picking", "Order Packing" to the slot
    Then "Alex Worker" should appear in the roster
    And the assigned tasks should be visible

  Scenario: SI cannot delete or modify SM users
    Given I am logged in as a Shift In Charge
    And there is a Store Manager user "John Manager"
    When I try to edit "John Manager"
    Then I should see an error "Shift In Charge cannot modify Store Manager accounts"
    When I try to delete "John Manager"
    Then I should see an error "Permission denied"

// ============================================================================
// User Story 3: SM Deletes User with Future Assignments
// ============================================================================

Feature: User Deletion with Reassignment
  As a Store Manager
  I want to delete users and handle their future roster assignments
  So that rosters remain consistent when staff leave

  Background:
    Given I am logged in as a Store Manager
    And I have a user "Temp Worker" with future roster assignments

  Scenario: SM deletes user with future assignments - reassign option
    Given "Temp Worker" has 3 future roster assignments
    When I click "Delete" on "Temp Worker"
    Then I should see a confirmation modal
    And the modal should show "3 future roster assignment(s)"
    And I should see option to "Reassign to user ID"
    When I enter reassign user ID "PP001"
    And I click "Delete User"
    Then "Temp Worker" should be deleted
    And all future assignments should be reassigned to "PP001"
    And the deletion should be logged in audit log

  Scenario: SM deletes user with future assignments - mark as vacant
    Given "Temp Worker" has 2 future roster assignments
    When I click "Delete" on "Temp Worker"
    And I check "Mark slots as vacant instead of reassigning"
    And I click "Delete User"
    Then "Temp Worker" should be deleted
    And the 2 roster slots should be marked as vacant
    And the deletion should be logged in audit log

  Scenario: SM cannot delete the last SM
    Given I am the only Store Manager in the store
    When I try to delete my own account
    Then I should see error "Cannot delete the last Store Manager. At least one SM must exist."
    And the deletion should be blocked

// ============================================================================
// User Story 4: Role Permission Changes
// ============================================================================

Feature: Role Permission Management
  As a Store Manager
  I want to edit role permissions and see impact preview
  So that I can adjust access controls safely

  Background:
    Given I am logged in as a Store Manager
    And I have a role "Shift In Charge" with 5 users assigned

  Scenario: SM edits role permissions with preview
    Given I am on the Role Management page
    When I click "Edit" on "Shift In Charge" role
    And I add permission "PUBLISH_ROSTER"
    And I click "Update"
    Then I should see a preview showing:
      | Affected Users | 5 |
      | Current Permission | CREATE_ROSTER, MODIFY_ROSTER |
      | New Permission | CREATE_ROSTER, MODIFY_ROSTER, PUBLISH_ROSTER |
    When I confirm the changes
    Then all 5 users with "Shift In Charge" role should have "PUBLISH_ROSTER" permission
    And the change should be logged in audit log

  Scenario: SM cannot delete role with assigned users
    Given "Shift In Charge" role has 5 users assigned
    When I try to delete "Shift In Charge" role
    Then I should see error "Cannot delete role because 5 user(s) are assigned to it"
    And I should see list of affected users
    And the deletion should be blocked

// ============================================================================
// User Story 5: Roster Validation and Publishing
// ============================================================================

Feature: Roster Validation
  As a Store Manager or Shift In Charge
  I want to validate rosters before publishing
  So that I ensure coverage and compliance with business rules

  Background:
    Given I am logged in as a Store Manager
    And I have staff members with various week-offs

  Scenario: Roster validation fails - duplicate assignment
    Given I am building a roster for "2024-01-27" morning shift
    When I assign "Alex Worker" to slot 1
    And I assign "Alex Worker" to slot 2
    And I click "Validate Roster"
    Then I should see error "Alex Worker is assigned to multiple slots on 2024-01-27"
    And the roster should not be publishable

  Scenario: Roster validation fails - week-off violation
    Given "Alex Worker" has week-off on "Sunday"
    And I am building a roster for "2024-01-28" (Sunday) morning shift
    When I assign "Alex Worker" to the roster
    And I click "Validate Roster"
    Then I should see error "Alex Worker has a week-off on this day"
    And the roster should not be publishable

  Scenario: Roster validation fails - insufficient coverage
    Given minimum staff per shift is 3
    And I am building a roster with only 2 staff members
    When I click "Validate Roster"
    Then I should see error "Minimum 3 staff required per shift"
    And the roster should not be publishable

  Scenario: Roster validation succeeds
    Given I have assigned 4 staff members to the roster
    And all staff are not on week-off
    And no staff is assigned twice
    When I click "Validate Roster"
    Then I should see "Roster is valid"
    And I should be able to publish the roster

// ============================================================================
// User Story 6: Export and Share Roster
// ============================================================================

Feature: Roster Export and Sharing
  As a Store Manager or Shift In Charge
  I want to export and share rosters
  So that staff and management can access roster information

  Background:
    Given I am logged in as a Store Manager
    And I have published rosters for the week

  Scenario: Export roster as CSV
    Given I am on the Roster Builder page
    When I click "Export"
    And I select format "CSV"
    And I set date range "2024-01-20" to "2024-01-27"
    And I check "Include metadata"
    And I click "Export"
    Then a CSV file should be downloaded
    And the CSV should contain roster data for the date range
    And the CSV should include metadata columns

  Scenario: Export roster as PDF
    Given I am on the Roster Builder page
    When I click "Export"
    And I select format "PDF"
    And I set date range "2024-01-20" to "2024-01-27"
    And I check "Include tasks"
    And I click "Export"
    Then a PDF file should be downloaded
    And the PDF should contain formatted roster data
    And the PDF should include task assignments

  Scenario: Share roster via email
    Given I have selected a published roster
    When I click "Share"
    And I select method "Email"
    And I enter recipients "staff@example.com, manager@example.com"
    And I enter message "Weekly roster for review"
    And I click "Share"
    Then the roster should be sent via email
    And the share action should be logged in audit log

  Scenario: Share roster via Slack
    Given I have selected a published roster
    And Slack integration is configured
    When I click "Share"
    And I select method "Slack"
    And I enter Slack user IDs "@user1, @user2"
    And I enter message "Weekly roster update"
    And I click "Share"
    Then the roster should be posted to Slack
    And the share action should be logged in audit log

// ============================================================================
// Edge Cases and Error Scenarios
// ============================================================================

Feature: Error Handling and Edge Cases

  Scenario: Bulk import with duplicate employee IDs
    Given I am on the User Management page
    When I try to bulk import CSV with duplicate employee IDs
    Then I should see errors for duplicate entries
    And non-duplicate entries should be imported successfully

  Scenario: Delete role with cascade option
    Given I have a role "Temp Role" with 3 users
    When I try to delete "Temp Role"
    Then I should see option to reassign users to another role
    When I select fallback role "Picker Packer (Warehouse)"
    And I confirm deletion
    Then "Temp Role" should be deleted
    And all 3 users should be reassigned to "Picker Packer (Warehouse)"

  Scenario: Roster validation - shift conflict
    Given "Alex Worker" is assigned to morning shift on "2024-01-27"
    When I try to assign "Alex Worker" to evening shift on "2024-01-27"
    Then I should see error "Alex Worker is already assigned to morning shift on 2024-01-27"
    And the assignment should be blocked
